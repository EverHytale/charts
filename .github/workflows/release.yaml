name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'
    tags:
      # Format: <chart-name>-v<version> (e.g., hytale-v0.1.0, hytale-v0.1.0-rc.1)
      - '*-v*'

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write

jobs:
  # Detect which charts have changed
  detect-charts:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.detect.outputs.charts }}
      chart_name: ${{ steps.parse-tag.outputs.chart_name }}
      chart_version: ${{ steps.parse-tag.outputs.chart_version }}
      is_release: ${{ steps.parse-tag.outputs.is_release }}
      is_prerelease: ${{ steps.parse-tag.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse tag (if tag push)
        id: parse-tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"

          # Extract chart name and version from tag (format: <chart>-v<version>)
          if [[ "$TAG" =~ ^(.+)-v(.+)$ ]]; then
            CHART_NAME="${BASH_REMATCH[1]}"
            CHART_VERSION="${BASH_REMATCH[2]}"
            echo "chart_name=$CHART_NAME" >> $GITHUB_OUTPUT
            echo "chart_version=$CHART_VERSION" >> $GITHUB_OUTPUT

            # Determine if release or prerelease
            if [[ "$CHART_VERSION" =~ (rc|alpha|beta)\. ]]; then
              echo "is_prerelease=true" >> $GITHUB_OUTPUT
              echo "is_release=false" >> $GITHUB_OUTPUT
            else
              echo "is_prerelease=false" >> $GITHUB_OUTPUT
              echo "is_release=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "Invalid tag format. Expected: <chart-name>-v<version>"
            exit 1
          fi

      - name: Detect changed charts (if push to main)
        id: detect
        if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
        run: |
          # Get list of changed chart directories
          CHANGED_CHARTS=$(git diff --name-only HEAD~1 HEAD -- charts/ | \
            grep -E '^charts/[^/]+/' | \
            cut -d'/' -f2 | \
            sort -u | \
            jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "Changed charts: $CHANGED_CHARTS"
          echo "charts=$CHANGED_CHARTS" >> $GITHUB_OUTPUT

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Lint all charts
        run: ct lint --config ct.yaml --all

  release:
    needs: [detect-charts, lint]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: ${{ fromJson(needs.detect-charts.outputs.chart_name != '' && format('["{0}"]', needs.detect-charts.outputs.chart_name) || needs.detect-charts.outputs.charts || '[]') }}
      fail-fast: false
    if: needs.detect-charts.outputs.chart_name != '' || (needs.detect-charts.outputs.charts != '' && needs.detect-charts.outputs.charts != '[]')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Determine version
        id: version
        run: |
          CHART="${{ matrix.chart }}"
          CHART_PATH="charts/$CHART"

          if [ ! -d "$CHART_PATH" ]; then
            echo "Chart directory not found: $CHART_PATH"
            exit 1
          fi

          # Get version from Chart.yaml
          CHART_VERSION=$(grep '^version:' "$CHART_PATH/Chart.yaml" | awk '{print $2}')

          # Determine version type
          if [[ "${{ needs.detect-charts.outputs.is_release }}" == "true" ]]; then
            echo "type=release" >> $GITHUB_OUTPUT
            echo "version=${{ needs.detect-charts.outputs.chart_version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.detect-charts.outputs.is_prerelease }}" == "true" ]]; then
            echo "type=prerelease" >> $GITHUB_OUTPUT
            echo "version=${{ needs.detect-charts.outputs.chart_version }}" >> $GITHUB_OUTPUT
          else
            DEV_VERSION="${CHART_VERSION}-dev.$(git rev-parse --short HEAD)"
            echo "type=dev" >> $GITHUB_OUTPUT
            echo "version=$DEV_VERSION" >> $GITHUB_OUTPUT
          fi

          echo "chart=$CHART" >> $GITHUB_OUTPUT
          echo "chart_path=$CHART_PATH" >> $GITHUB_OUTPUT

      - name: Package chart
        run: |
          mkdir -p .cr-release-packages
          helm package "${{ steps.version.outputs.chart_path }}" -d .cr-release-packages

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push chart to OCI registry
        run: |
          for pkg in .cr-release-packages/*.tgz; do
            if [ -f "$pkg" ]; then
              echo "ðŸ“¦ Pushing $pkg to oci://ghcr.io/${{ github.repository_owner }}"
              helm push "$pkg" oci://ghcr.io/${{ github.repository_owner }}
            fi
          done

      - name: Summary
        run: |
          echo "## ðŸ“¦ Chart Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | ${{ steps.version.outputs.chart }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type | ${{ steps.version.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OCI Registry | ghcr.io/${{ github.repository_owner }}/${{ steps.version.outputs.chart }} |" >> $GITHUB_STEP_SUMMARY

  # Update GitHub Pages index
  pages:
    needs: [detect-charts, release]
    if: needs.detect-charts.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
